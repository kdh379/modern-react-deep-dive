# 가상 DOM과 리액트 파이버

## 가상 DOM이란?

실제 DOM의 가벼운 복사본으로, 메모리에서 관리되는 JS 객체이다.  
이를 활용하여 DOM 조작을 최소화하고, 성능을 최적화할 수 있다.

## DOM과 브라우저 렌더링 과정

DOM(Document Object Model)은 웹페이지에 대한 인터페이스이다.  
브라우저가 웹페이지의 콘텐츠와 구조를 표현하고 조작하는 방식을 정의한다.

1. HTML 파일 다운로드
2. HTML 파싱 및 DOM 트리 생성
3. CSS 파일 다운로드
4. CSS 파싱 및 CSSOM 트리 생성
5. 렌더 트리 생성 및 처리
    - 레이아웃: 각 요소의 크기와 위치 계산
    - 페인팅: 화면에 실제 픽셀 렌더링

### 성능 최적화 고려사항

레이아웃(reflow)를 유발하는 속성의 동적 변경은 성능에 악영향을 미친다.

- width/height
- margin/padding
- top/left/right/bottom

## 가상 DOM의 탄생 배경

### 현대 웹페이지의 특징

1. 동적 콘텐츠의 증가
   - 빈번한 요소 노출 변경
   - 동적 크기 조정
   - 잦은 reflow/repaint 발생
2. SPA(Single Page Application)의 확산
   - 클라이언트 사이드 렌더링 증가
   - DOM 조작 빈도 증가

### 가상 DOM의 장점

1. 메모리 내 DOM 처리
   - 실제 DOM 변경 전 메모리에서 변경사항 계산
   - react-dom을 통해 최소한의 실제 DOM 조작
2. 렌더링 최적화
   - 여러 변경사항을 일괄처리
   - 불필요한 렌더링 감소

### 성능 고려사항

- 가상 DOM이 항상 실제 DOM 조작보다 빠른 것은 아니다.
- 대규모 웹 앱에서 안정적인 성능 제공
- 실제 DOM에는 최종 결과물만 반영되므로 성능 최적화에 유리

## 가상 DOM을 위한 아키텍처, 리액트 파이버

### 리액트 파이버란?

리액트 파이버는 가상 DOM과 실제DOM간의 변경 사항을 효율적으로 처리하는 조정자(Reconciler)이다.  
모든 작업을 비동기적으로 처리하여 웹 앱의 성능과 사용자 경험을 향상시킨다.

#### 과거와 현재의 차이

- **과거**: 스택 기반의 동기적 처리
  - 렌더링 중 다른 작업 불가능
  - 사용자 입력과 같은 높은 우선순위의 작업 지연
- **현재**: 파이버 기반의 비동기적 처리
  - 작업 우선순위 조정 가능
  - 렌더링 중단 및 재개 가능

### 파이버는 어떻게 동작하는가

#### 기본 구조

- 컴포넌트당 하나의 파이버 인스턴스 생성
- 최초 마운트 시 생성 후 가급적 재사용
- state 변경, 라이프 사이클 이벤트 발생 시 업데이트

#### 처리 단계

1. **렌더 단계**(비동기)
   - 사용자에게 노출되지 않는 작업 수행
   - 작업 우선순위 지정
   - 작업 중단/재개/폐기 가능
2. **커밋 단계**(동기)
   - DOM 변경사항 실제 반영
   - 중단 불가능
   - 순차적 처리

### 리액트 파이버 트리

#### 트리 구조

- **current 트리**: 현재 화면에 렌더링된 상태
- **workInProgress 트리**: 진행 중인 작업 상태

#### 더블 버퍼링

더블 버퍼링은 컴퓨터 그래픽 분야에서 많이 사용되는 기법  
렌더링 중인 화면을 사용자에게 노출하지 않고, 렌더링이 완료된 화면을 사용자에게 노출한다.

1. current트리 기반의 작업 시작
2. 변경사항이 발생하면 workInProgress 트리 빌드 시작
3. 빌드 완료 후 workInProgress 트리를 새로운 current 트리로 설정

### 파이버의 작업 순서

파이버 작업 순서 (깊이 우선 탐색):

1. Root에서 시작: beginWork() 호출
2. 자식 노드가 있다면 자식 노드로 이동하여 beginWork() 함수를 호출하며 재귀
3. 더 이상 자식이 없는 경우 completeWork() 호출 후 상위 노드로 이동
4. 형제 노드가 있다면 형제 노드로 넘어가 beginWork() 호출 후 2번 반복
5. 2, 3, 4번이 모두 완료되면 Root로 복귀하여 completeWork() 호출
6. 최종적으로 commitWork()가 수행되고, 변경 사항을 비교해 DOM에 반영한다.

이 후 상태 변경으로 인해 **리렌더링**이 발생하면,

- 새 노드 생성 대신 기존 파이버 재사용
- **더블 버퍼링**으로 효율적인 업데이트 처리

## 파이버와 가상 DOM

### 핵심 기능

- 컴포넌트와 파이버의 1:1 매핑
- 비동기 작업 처리
- 메모리 내에서 DOM에 그릴 작업 수행
- 최종 결과물만 DOM 업데이트
